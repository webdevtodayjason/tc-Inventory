{% extends "base.html" %}

{% block title %}Add New Item{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-md-8">
            <h2>Add New Item</h2>
        </div>
        <div class="col-md-4 text-end">
            <a href="{{ url_for('inventory.dashboard') }}" class="btn btn-secondary">Back to Dashboard</a>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <form method="POST" id="itemForm">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                
                <!-- Barcode Lookup Section -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Barcode Lookup</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="input-group">
                                    <input type="text" class="form-control" id="barcode" name="barcode" placeholder="Scan or enter barcode" autocomplete="off">
                                    <button type="button" class="btn btn-outline-secondary" id="scanButton">
                                        <i class="fas fa-barcode"></i> Scan
                                    </button>
                                    <button type="button" class="btn btn-primary" id="lookupButton">
                                        <i class="fas fa-search"></i> Lookup
                                    </button>
                                </div>
                                <div id="lookupStatus" class="form-text mt-2"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="name" class="form-label">Name</label>
                            {{ form.name(class="form-control", required=true) }}
                            {% if form.name.errors %}
                                {% for error in form.name.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                            {% endif %}
                        </div>
                        <div class="mb-3">
                            <label for="category" class="form-label">Category</label>
                            <select class="form-select" id="category" name="category" required>
                                <option value="">Select a category</option>
                                {% for category in form.category.choices %}
                                <option value="{{ category[0] }}" {% if category[0] == form.category.data %}selected{% endif %}>
                                    {{ category[1] }}
                                </option>
                                {% endfor %}
                            </select>
                            {% if form.category.errors %}
                                {% for error in form.category.errors %}
                                    <div class="invalid-feedback">{{ error }}</div>
                                {% endfor %}
                            {% endif %}
                        </div>
                        <div class="mb-3">
                            <label for="quantity" class="form-label">Quantity</label>
                            {{ form.quantity(class="form-control", type="number", min="0", required=true) }}
                            {% if form.quantity.errors %}
                                {% for error in form.quantity.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                            {% endif %}
                        </div>
                        <div class="mb-3">
                            <label for="reorder_threshold" class="form-label">Reorder Point</label>
                            {{ form.reorder_threshold(class="form-control", type="number", min="0") }}
                            {% if form.reorder_threshold.errors %}
                                {% for error in form.reorder_threshold.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                            {% endif %}
                        </div>
                        <div class="mb-3">
                            <label for="storage_location" class="form-label">Storage Location</label>
                            {{ form.storage_location(class="form-control") }}
                        </div>
                        <div class="mb-3">
                            <label for="manufacturer" class="form-label">Manufacturer</label>
                            {{ form.manufacturer(class="form-control") }}
                        </div>
                        <div class="mb-3">
                            <label for="mpn" class="form-label">Manufacturer Part Number (MPN)</label>
                            {{ form.mpn(class="form-control") }}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="description" class="form-label">Description</label>
                            {{ form.description(class="form-control", rows="3") }}
                        </div>
                        <div class="mb-3">
                            <label for="cost" class="form-label">Cost (USD)</label>
                            {{ form.cost(class="form-control", type="number", step="0.01", min="0") }}
                        </div>
                        <div class="mb-3">
                            <label for="sell_price" class="form-label">Sell Price (USD)</label>
                            {{ form.sell_price(class="form-control", type="number", step="0.01", min="0") }}
                        </div>
                        <div class="mb-3">
                            <label for="purchase_url" class="form-label">Purchase URL</label>
                            {{ form.purchase_url(class="form-control", type="url", placeholder="https://...") }}
                        </div>
                        <div class="mb-3">
                            <label for="image_url" class="form-label">Image URL</label>
                            {{ form.image_url(class="form-control", type="url", placeholder="https://...") }}
                            <div id="imagePreview" class="mt-2"></div>
                        </div>
                        <div class="mb-3">
                            <label for="tags" class="form-label">Tags</label>
                            {{ form.tags(class="form-select", multiple=true) }}
                            <div class="form-text">Hold Ctrl/Cmd to select multiple tags</div>
                        </div>
                    </div>
                </div>

                <div class="text-end">
                    <button type="submit" class="btn btn-primary">Add Item</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Barcode Scanner Modal -->
<div class="modal fade" id="scannerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Scan Barcode</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="scanner-container"></div>
                <div id="scanResult"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/html5-qrcode"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM Content Loaded - Add Item Page');
    
    // Check if elements exist
    const lookupButton = document.getElementById('lookupButton');
    const barcodeInput = document.getElementById('barcode');
    const lookupStatus = document.getElementById('lookupStatus');
    
    console.log('Elements found:', {
        lookupButton: !!lookupButton,
        barcodeInput: !!barcodeInput,
        lookupStatus: !!lookupStatus
    });

    if (lookupButton) {
        lookupButton.addEventListener('click', async function() {
            console.log('Lookup button clicked');
            const barcode = barcodeInput.value;
            console.log('Barcode value:', barcode);

            if (!barcode) {
                lookupStatus.innerHTML = '<div class="text-danger">Please enter a barcode</div>';
                return;
            }

            lookupStatus.innerHTML = '<div class="text-info">Looking up barcode...</div>';

            try {
                const csrfToken = document.querySelector('input[name="csrf_token"]').value;
                console.log('CSRF Token exists:', !!csrfToken);
                
                console.log('Making API request...');
                const response = await fetch('/scan_barcode', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ barcode: barcode })
                });

                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Response data:', data);

                if (data.success) {
                    // Update form fields with the retrieved data
                    document.getElementById('name').value = data.name || '';
                    document.getElementById('description').value = data.description || '';
                    document.getElementById('manufacturer').value = data.manufacturer || '';
                    document.getElementById('mpn').value = data.mpn || '';
                    document.getElementById('image_url').value = data.image_url || '';
                    
                    // Update category if found
                    if (data.category_id) {
                        const categorySelect = document.getElementById('category');
                        categorySelect.value = data.category_id;
                        
                        // If the category doesn't exist in the dropdown, add it
                        if (!categorySelect.value) {
                            const option = new Option(data.category_name, data.category_id);
                            categorySelect.add(option);
                            categorySelect.value = data.category_id;
                        }
                    }
                    
                    // Trigger the image preview update
                    const event = new Event('change');
                    document.getElementById('image_url').dispatchEvent(event);
                    
                    lookupStatus.innerHTML = '<div class="text-success">Product information found!</div>';
                } else {
                    lookupStatus.innerHTML = `<div class="text-danger">${data.message || 'No product information found'}</div>`;
                }
            } catch (error) {
                console.error('Error:', error);
                lookupStatus.innerHTML = '<div class="text-danger">Error looking up barcode. Please try again.</div>';
            }
        });
    } else {
        console.error('Lookup button not found!');
    }
});
</script>
{% endblock %} 