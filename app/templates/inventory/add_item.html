{% extends "base.html" %}

{% block title %}Add New Item{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-md-8">
            <h2>Add New Item</h2>
        </div>
        <div class="col-md-4 text-end">
            <a href="{{ url_for('inventory.dashboard') }}" class="btn btn-secondary">Back to Dashboard</a>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <form method="POST" id="itemForm">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                
                <!-- Barcode Lookup Section -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Barcode Lookup</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="input-group">
                                    <input type="text" class="form-control" id="barcode" name="barcode" placeholder="Scan or enter barcode" autocomplete="off">
                                    <button type="button" class="btn btn-outline-secondary" id="scanButton">
                                        <i class="fas fa-barcode"></i> Scan
                                    </button>
                                    <button type="button" class="btn btn-primary" id="lookupButton">
                                        <i class="fas fa-search"></i> Lookup
                                    </button>
                                </div>
                                <div id="lookupStatus" class="form-text mt-2"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="name" class="form-label">Name</label>
                            {{ form.name(class="form-control", required=true) }}
                            {% if form.name.errors %}
                                {% for error in form.name.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                            {% endif %}
                        </div>
                        <div class="mb-3">
                            <label for="category" class="form-label">Category</label>
                            {{ form.category(class="form-select", required=true) }}
                            {% if form.category.errors %}
                                {% for error in form.category.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                            {% endif %}
                        </div>
                        <div class="mb-3">
                            <label for="quantity" class="form-label">Quantity</label>
                            {{ form.quantity(class="form-control", type="number", min="0", required=true) }}
                            {% if form.quantity.errors %}
                                {% for error in form.quantity.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                            {% endif %}
                        </div>
                        <div class="mb-3">
                            <label for="reorder_threshold" class="form-label">Reorder Point</label>
                            {{ form.reorder_threshold(class="form-control", type="number", min="0") }}
                            {% if form.reorder_threshold.errors %}
                                {% for error in form.reorder_threshold.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                            {% endif %}
                        </div>
                        <div class="mb-3">
                            <label for="storage_location" class="form-label">Storage Location</label>
                            {{ form.storage_location(class="form-control") }}
                        </div>
                        <div class="mb-3">
                            <label for="manufacturer" class="form-label">Manufacturer</label>
                            {{ form.manufacturer(class="form-control") }}
                        </div>
                        <div class="mb-3">
                            <label for="mpn" class="form-label">Manufacturer Part Number (MPN)</label>
                            {{ form.mpn(class="form-control") }}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="description" class="form-label">Description</label>
                            {{ form.description(class="form-control", rows="3") }}
                        </div>
                        <div class="mb-3">
                            <label for="cost" class="form-label">Cost (USD)</label>
                            {{ form.cost(class="form-control", type="number", step="0.01", min="0") }}
                        </div>
                        <div class="mb-3">
                            <label for="sell_price" class="form-label">Sell Price (USD)</label>
                            {{ form.sell_price(class="form-control", type="number", step="0.01", min="0") }}
                        </div>
                        <div class="mb-3">
                            <label for="purchase_url" class="form-label">Purchase URL</label>
                            {{ form.purchase_url(class="form-control", type="url", placeholder="https://...") }}
                        </div>
                        <div class="mb-3">
                            <label for="image_url" class="form-label">Image URL</label>
                            {{ form.image_url(class="form-control", type="url", placeholder="https://...") }}
                            <div id="imagePreview" class="mt-2"></div>
                        </div>
                        <div class="mb-3">
                            <label for="tags" class="form-label">Tags</label>
                            {{ form.tags(class="form-select", multiple=true) }}
                            <div class="form-text">Hold Ctrl/Cmd to select multiple tags</div>
                        </div>
                    </div>
                </div>

                <div class="text-end">
                    <button type="submit" class="btn btn-primary">Add Item</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Barcode Scanner Modal -->
<div class="modal fade" id="scannerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Scan Barcode</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="scanner-container"></div>
                <div id="scanResult"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/html5-qrcode"></script>
<script>
function showMessage(message, isError = false) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${isError ? 'danger' : 'success'} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Find the container and the first card
    const container = document.querySelector('.container.mt-4');
    if (container) {
        // Insert at the beginning of the container
        container.insertBefore(alertDiv, container.firstChild);
        
        // Auto-dismiss after 5 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }
}

// Image URL preview
document.getElementById('image_url').addEventListener('change', function() {
    const imageUrl = this.value;
    const previewDiv = document.getElementById('imagePreview');
    
    if (imageUrl) {
        const img = document.createElement('img');
        img.src = imageUrl;
        img.style.maxWidth = '200px';
        img.style.maxHeight = '200px';
        img.onerror = function() {
            previewDiv.innerHTML = '<div class="text-danger">Invalid image URL</div>';
        };
        previewDiv.innerHTML = '';
        previewDiv.appendChild(img);
    } else {
        previewDiv.innerHTML = '';
    }
});

// Barcode scanner functionality
let html5QrcodeScanner = null;

document.getElementById('scanButton').addEventListener('click', function() {
    const modal = new bootstrap.Modal(document.getElementById('scannerModal'));
    modal.show();
    
    if (!html5QrcodeScanner) {
        html5QrcodeScanner = new Html5QrcodeScanner(
            "scanner-container", { fps: 10, qrbox: 250 }
        );
        
        html5QrcodeScanner.render((decodedText) => {
            document.getElementById('barcode').value = decodedText;
            html5QrcodeScanner.clear();
            modal.hide();
            document.getElementById('lookupButton').click();
        });
    }
});

document.getElementById('scannerModal').addEventListener('hidden.bs.modal', function() {
    if (html5QrcodeScanner) {
        html5QrcodeScanner.clear();
    }
});
</script>
{% endblock %} 